<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Drink60</title>
  </head>
  <body>

    <header>
      <h1>Drink60</h1>
    </header>

    <button id="getSong">Start</button>

    <audio id="audio" controls="controls"></audio>

    <div class="current-game">
      <p>You have made it through <span id="playCount"></span></p>
    </div>

    <div class="current-song-container">
      <h2>Current Song</h2>
      <p>
        Title: <span id="songTitle"></span>
      </p>
      <p>
        Artist: <span id="songArtist"></span>
      </p>
    </div>

    <script>

      var btn = document.getElementById('getSong');
      var audio = document.getElementById('audio')
      var songTitleDisplay = document.getElementById('songTitle');
      var songArtistDispay = document.getElementById('songArtist');

      var playCount = 0;
      var playCountElement = document.getElementById('playCount');

      var tracks = [];

      btn.addEventListener('click', start);

      function fetchSongs(cb) {
        var request = new XMLHttpRequest();
        request.open('GET', '/getSong', true);

        request.onload = function() {
          var data = JSON.parse(request.responseText);
          tracks = tracks.concat(data);

          if (cb) {
            cb(tracks);
          }
        };

        request.send();
      }

      function updateSongInformation(track) {
        songTitleDisplay.textContent = track.title;
        songArtistDispay.textContent = track.artist;

        playCountElement.textContent = playCount === 1 ? '1 song' : playCount + ' songs';
        playCount = playCount + 1;
      }

      function playSong(audioElement, track, timeout) {
        setTimeout(function() {
          fetchSongs(function() {
            updateSongInformation(track);
            audioElement.src = track.url;
            audioElement.load();
            audioElement.play();
            playSong(audioElement, tracks.shift(), 60 * 1000);
          });

        }, timeout);
      }

      function start() {
        fetchSongs(function(tracks) {
          playSong(audio, tracks.shift(), 0);
        });
      }

    </script>
  </body>
</html>
